<!-- QGen/QPaperGeneration/templates/explore_data.html -->
{% extends "layout.html" %}

{% block title %}Explore Data - QGen Admin{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark text-white shadow-lg">
                <div class="card-body py-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="display-6 fw-bold mb-2">
                                <i class="fas fa-database me-3"></i>Explore System Data
                            </h1>
                            <p class="lead mb-0">Browse and analyze all questions, subjects, and system information</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="bg-white bg-opacity-25 rounded-pill px-3 py-2 d-inline-block">
                                <i class="fas fa-search me-2"></i>
                                <span class="fw-bold">Data Explorer</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-2 col-6 mb-3">
            <div class="card border-0 shadow-sm h-100 text-center">
                <div class="card-body">
                    <div class="text-primary mb-2">
                        <i class="fas fa-question-circle fa-2x"></i>
                    </div>
                    <h4 class="text-primary mb-1">{{ total_questions }}</h4>
                    <p class="text-muted mb-0">Total Questions</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="card border-0 shadow-sm h-100 text-center">
                <div class="card-body">
                    <div class="text-success mb-2">
                        <i class="fas fa-book fa-2x"></i>
                    </div>
                    <h4 class="text-success mb-1">{{ total_subjects }}</h4>
                    <p class="text-muted mb-0">Subjects</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="card border-0 shadow-sm h-100 text-center">
                <div class="card-body">
                    <div class="text-info mb-2">
                        <i class="fas fa-tags fa-2x"></i>
                    </div>
                    <h4 class="text-info mb-1">{{ total_topics }}</h4>
                    <p class="text-muted mb-0">Topics</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="card border-0 shadow-sm h-100 text-center">
                <div class="card-body">
                    <div class="text-warning mb-2">
                        <i class="fas fa-file-pdf fa-2x"></i>
                    </div>
                    <h4 class="text-warning mb-1">{{ total_generated_papers }}</h4>
                    <p class="text-muted mb-0">Generated Papers</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="card border-0 shadow-sm h-100 text-center">
                <div class="card-body">
                    <div class="text-danger mb-2">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                    <h4 class="text-danger mb-1">{{ total_users }}</h4>
                    <p class="text-muted mb-0">Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="card border-0 shadow-sm h-100 text-center">
                <div class="card-body">
                    <div class="text-secondary mb-2">
                        <i class="fas fa-chart-bar fa-2x"></i>
                    </div>
                    <h4 class="text-secondary mb-1">{{ marks_distribution.total }}</h4>
                    <p class="text-muted mb-0">Total Marks</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="GET" action="{% url 'explore_data' %}" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">Search Questions</label>
                            <input type="text" name="search" class="form-control" placeholder="Search question text..." value="{{ search_query }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Subject</label>
                            <select name="subject" class="form-select">
                                <option value="">All Subjects</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}" {% if selected_subject == subject.id|stringformat:"i" %}selected{% endif %}>
                                    {{ subject.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Marks</label>
                            <select name="marks" class="form-select">
                                <option value="">All Marks</option>
                                <option value="2" {% if selected_marks == "2" %}selected{% endif %}>2 Marks</option>
                                <option value="5" {% if selected_marks == "5" %}selected{% endif %}>5 Marks</option>
                                <option value="10" {% if selected_marks == "10" %}selected{% endif %}>10 Marks</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Difficulty</label>
                            <select name="difficulty" class="form-select">
                                <option value="">All Levels</option>
                                {% for i in "12345" %}
                                <option value="{{ i }}" {% if selected_difficulty == i %}selected{% endif %}>Level {{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">User</label>
                            <select name="user" class="form-select">
                                <option value="">All Users</option>
                                {% for user in all_users %}
                                <option value="{{ user.id }}" {% if selected_user == user.id|stringformat:"i" %}selected{% endif %}>
                                    {{ user.username }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-1"></i> Filter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <ul class="nav nav-tabs card-header-tabs" id="dataTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button" role="tab">
                                <i class="fas fa-question-circle me-2"></i>Questions ({{ questions.paginator.count }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="subjects-tab" data-bs-toggle="tab" data-bs-target="#subjects" type="button" role="tab">
                                <i class="fas fa-book me-2"></i>Subjects & Topics
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="papers-tab" data-bs-toggle="tab" data-bs-target="#papers" type="button" role="tab">
                                <i class="fas fa-file-pdf me-2"></i>Generated Papers ({{ generated_papers.paginator.count }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab">
                                <i class="fas fa-chart-pie me-2"></i>Statistics
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="dataTabsContent">
                        
                        <!-- Questions Tab -->
                        <div class="tab-pane fade show active" id="questions" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">All Questions</h5>
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary btn-sm" onclick="exportQuestions('csv')">
                                        <i class="fas fa-download me-1"></i>Export CSV
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" onclick="exportQuestions('json')">
                                        <i class="fas fa-download me-1"></i>Export JSON
                                    </button>
                                </div>
                            </div>
                            
                            {% if questions %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Question Preview</th>
                                            <th>Subject</th>
                                            <th>Topic</th>
                                            <th>Marks</th>
                                            <th>Difficulty</th>
                                            <th>Created By</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for question in questions %}
                                        <tr>
                                            <td><strong>#{{ question.id }}</strong></td>
                                            <td>
                                                <div class="question-preview">
                                                    {{ question.question|truncatewords:15 }}
                                                </div>
                                                <small class="text-muted">{{ question.question|length }} characters</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ question.subject.name }}</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">{{ question.topic.name }}</span>
                                            </td>
                                            <td>
                                                <span class="badge {% if question.marks == 2 %}bg-primary{% elif question.marks == 5 %}bg-warning{% else %}bg-success{% endif %}">
                                                    {{ question.marks }} marks
                                                </span>
                                            </td>
                                            <td>
                                                <div class="difficulty-stars">
                                                    {% for i in "12345" %}
                                                    <i class="fas fa-star{% if forloop.counter > question.difficulty %}-o text-muted{% else %} text-warning{% endif %}"></i>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                            <td>
                                                <small>{{ question.user.username }}</small>
                                                <br>
                                                <small class="text-muted">{{ question.user.role }}</small>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="viewQuestionDetail({{ question.id }})">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <a href="{% url 'download_paper_pdf' question.id %}" class="btn btn-outline-success">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                    {% if request.user.role == 'admin' or question.user == request.user %}
                                                    <button class="btn btn-outline-danger" onclick="deleteQuestion({{ question.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            {% if questions.has_other_pages %}
                            <nav aria-label="Questions pagination">
                                <ul class="pagination justify-content-center">
                                    {% if questions.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ questions.previous_page_number }}">Previous</a>
                                    </li>
                                    {% endif %}
                                    
                                    {% for i in questions.paginator.page_range %}
                                    {% if questions.number == i %}
                                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                                    {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ i }}">{{ i }}</a>
                                    </li>
                                    {% endif %}
                                    {% endfor %}
                                    
                                    {% if questions.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ questions.next_page_number }}">Next</a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </nav>
                            {% endif %}
                            
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No questions found</h5>
                                <p class="text-muted">Try adjusting your filters or add new questions.</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Subjects & Topics Tab -->
                        <div class="tab-pane fade" id="subjects" role="tabpanel">
                            <div class="row">
                                {% for subject in subjects_with_stats %}
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100 border-0 shadow-sm">
                                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">
                                                <i class="fas fa-book me-2"></i>{{ subject.name }}
                                            </h6>
                                            <span class="badge bg-white text-primary">{{ subject.question_count }} questions</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <small class="text-muted">Marks Distribution:</small>
                                                <div class="progress mb-1" style="height: 8px;">
                                                    <div class="progress-bar bg-primary" style="width: {{ subject.marks_2_percent }}%"></div>
                                                    <div class="progress-bar bg-warning" style="width: {{ subject.marks_5_percent }}%"></div>
                                                    <div class="progress-bar bg-success" style="width: {{ subject.marks_10_percent }}%"></div>
                                                </div>
                                                <div class="d-flex justify-content-between small text-muted">
                                                    <span>2m: {{ subject.marks_2_count }}</span>
                                                    <span>5m: {{ subject.marks_5_count }}</span>
                                                    <span>10m: {{ subject.marks_10_count }}</span>
                                                </div>
                                            </div>
                                            
                                            <small class="text-muted d-block mb-2">Topics:</small>
                                            <div class="topic-list">
                                                {% for topic in subject.topics %}
                                                <span class="badge bg-light text-dark me-1 mb-1">
                                                    {{ topic.name }} ({{ topic.question_count }})
                                                </span>
                                                {% empty %}
                                                <small class="text-muted">No topics found</small>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Generated Papers Tab -->
                        <div class="tab-pane fade" id="papers" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Student Generated Papers</h5>
                                <small class="text-muted">Total: {{ total_generated_papers }} papers</small>
                            </div>
                            
                            {% if generated_papers %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Paper ID</th>
                                            <th>Title</th>
                                            <th>Student</th>
                                            <th>Questions</th>
                                            <th>Total Marks</th>
                                            <th>Created Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for paper in generated_papers %}
                                        <tr>
                                            <td><strong>#{{ paper.id }}</strong></td>
                                            <td>{{ paper.title }}</td>
                                            <td>
                                                <small>{{ paper.student.username }}</small>
                                                <br>
                                                <small class="text-muted">{{ paper.student.email }}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ paper.number_of_questions }}</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">{{ paper.total_marks }} marks</span>
                                            </td>
                                            <td>
                                                <small>{{ paper.created_at|date:"M d, Y" }}</small>
                                                <br>
                                                <small class="text-muted">{{ paper.created_at|timesince }} ago</small>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{% url 'student_download_generated_paper' paper.id %}" class="btn btn-outline-success">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                    <button class="btn btn-outline-info" onclick="viewPaperDetails({{ paper.id }})">
                                                        <i class="fas fa-info-circle"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            {% if generated_papers.has_other_pages %}
                            <nav aria-label="Papers pagination">
                                <ul class="pagination justify-content-center">
                                    {% if generated_papers.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=papers&page_papers={{ generated_papers.previous_page_number }}">Previous</a>
                                    </li>
                                    {% endif %}
                                    
                                    {% for i in generated_papers.paginator.page_range %}
                                    {% if generated_papers.number == i %}
                                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                                    {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=papers&page_papers={{ i }}">{{ i }}</a>
                                    </li>
                                    {% endif %}
                                    {% endfor %}
                                    
                                    {% if generated_papers.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=papers&page_papers={{ generated_papers.next_page_number }}">Next</a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </nav>
                            {% endif %}
                            
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-file-pdf fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No generated papers found</h5>
                                <p class="text-muted">Students haven't generated any papers yet.</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Statistics Tab -->
                        <div class="tab-pane fade" id="stats" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-header bg-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-chart-pie me-2 text-primary"></i>Marks Distribution
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="marksChart" width="400" height="300"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-header bg-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-star me-2 text-warning"></i>Difficulty Distribution
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="difficultyChart" width="400" height="300"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-header bg-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-book me-2 text-info"></i>Questions per Subject
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="subjectChart" width="400" height="300"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-header bg-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-users me-2 text-success"></i>Questions per User
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="userChart" width="400" height="300"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Question Detail Modal -->
<div class="modal fade" id="questionDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Question Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="questionDetailContent">
                <!-- Content will be loaded via AJAX -->
            </div>
        </div>
    </div>
</div>
<div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{% url 'admin_dashboard' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<style>
.difficulty-stars {
    font-size: 0.8rem;
}

.question-preview {
    max-width: 300px;
    word-wrap: break-word;
}

.nav-tabs .nav-link {
    font-weight: 500;
}

.nav-tabs .nav-link.active {
    font-weight: 600;
}

.topic-list {
    max-height: 120px;
    overflow-y: auto;
}

.progress {
    border-radius: 10px;
}

.table th {
    border-top: none;
    font-weight: 600;
}

.card {
    border-radius: 12px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize charts when stats tab is shown
document.getElementById('stats-tab').addEventListener('shown.bs.tab', function() {
    initializeCharts();
});

function initializeCharts() {
    // Marks Distribution Chart
    const marksCtx = document.getElementById('marksChart').getContext('2d');
    new Chart(marksCtx, {
        type: 'pie',
        data: {
            labels: ['2 Marks', '5 Marks', '10 Marks'],
            datasets: [{
                data: [
                    {{ marks_distribution.marks_2 }},
                    {{ marks_distribution.marks_5 }}, 
                    {{ marks_distribution.marks_10 }}
                ],
                backgroundColor: ['#4361ee', '#ffd166', '#06d6a0']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Difficulty Distribution Chart
    const difficultyCtx = document.getElementById('difficultyChart').getContext('2d');
    new Chart(difficultyCtx, {
        type: 'bar',
        data: {
            labels: ['Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5'],
            datasets: [{
                label: 'Number of Questions',
                data: [
                    {{ difficulty_distribution.level_1 }},
                    {{ difficulty_distribution.level_2 }},
                    {{ difficulty_distribution.level_3 }},
                    {{ difficulty_distribution.level_4 }},
                    {{ difficulty_distribution.level_5 }}
                ],
                backgroundColor: '#4361ee'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Questions per Subject Chart
    const subjectCtx = document.getElementById('subjectChart').getContext('2d');
    new Chart(subjectCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for subject in subjects_with_stats %}'{{ subject.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for subject in subjects_with_stats %}{{ subject.question_count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#4361ee', '#3a0ca3', '#7209b7', '#f72585', '#4cc9f0', '#4895ef']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// View question details
function viewQuestionDetail(questionId) {
    fetch(`/question/${questionId}/detail/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('questionDetailContent').innerHTML = data.html;
                new bootstrap.Modal(document.getElementById('questionDetailModal')).show();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading question details');
        });
}

// Export questions
function exportQuestions(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('export', format);
    window.location.href = `{% url 'explore_data' %}?${params.toString()}`;
}

// Delete question
function deleteQuestion(questionId) {
    if (confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
        fetch(`/question/${questionId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error deleting question');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting question');
        });
    }
}

// View paper details
function viewPaperDetails(paperId) {
    alert('Paper details for ID: ' + paperId);
    // Implement paper details view as needed
}

// Initialize charts on page load if stats tab is active
document.addEventListener('DOMContentLoaded', function() {
    const activeTab = new URLSearchParams(window.location.search).get('tab');
    if (activeTab === 'stats' || !activeTab) {
        initializeCharts();
    }
});
</script>
{% endblock %}